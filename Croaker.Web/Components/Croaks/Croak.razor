@using Microsoft.AspNetCore.Identity
@using AspNetCore.Identity.LiteDB.Models
@using edu_croaker.Data.Dtos
@using edu_croaker.Services

@inject CroakService CroakSrv
@inject UserManager<ApplicationUser> UserMgr

@namespace Components

<style>
    .croak-content {
        overflow-wrap: break-word;
    }

    .croak-icon {
        font-size: 11px;
    }

    .croak-icon-mid {
        font-size: 15px;
    }

    .hashtags {
        padding-top: 5px;
    }

    .rm {
        padding-top: 7px;
        padding-right: 7px;
    }

    .liked {
        color: dodgerblue;
    }
</style>

<div class="card flex-row">
    <div class="card-body">
        <blockquote class="blockquote mb-0">
            <p class="croak-content">@CroakData.Content</p>
            <footer class="blockquote-footer text-muted">
                <small>
                    by
                    <cite title="Source Title"><a href="/byUser/@CroakData.AuthorName">@CroakData.AuthorName</a></cite>  |
                </small>
                <!--<a @onclick="OnPressShare" class="badge badge-light croak-icon pointer no-select">
                    @CroakData.SharesCount
                    <i class="material-icons croak-icon">share</i>
                </a>-->
                <a @onclick="(async () => await OnPressLikeAsync())" class="badge badge-light croak-icon pointer no-select">
                    <span class="@(IsLiked ? "liked" : "")">
                        @CroakData.LikesCount
                        <i class="material-icons croak-icon">thumb_up</i>
                    </span>
                </a>
            </footer>
        </blockquote>
        <div class="hashtags">
            @foreach (var hashtag in CroakData.Hashtags)
            {
                <a href="/byHashtag/@hashtag" class="badge badge-pill badge-light">#@hashtag</a>
            }
        </div>
    </div>
    @if (IsDeletable)
    {
        <div class="rm">
            <a @onclick="Remove"
                type="button"
                class="close"
                aria-label="Delete">
                <span class="material-icons croak-icon-mid">delete_forever</span>
            </a>
        </div>
    }
</div>

@code {
    [Parameter]
    public CroakDto CroakData { get; set; }

    [CascadingParameter]
    public Task<AuthenticationState> AuthStateTask { get; set; }

    private bool IsDeletable { get; set; } = false;

    private bool IsLiked { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        IsDeletable = await IsDeletableForCurrUser();
    }

    protected override async Task OnParametersSetAsync()
    {
        await UpdateIsLiked();
    }

    private void OnPressShare()
    {
        CroakData.SharesCount += 1;
    }

    private async Task OnPressLikeAsync()
    {
        var likeDto = await CreateLikeDto();

        if (!IsLiked)
        {
            if (await CroakSrv.LikeCroakAsync(likeDto))
            {
                CroakData.LikesCount++;
            }
        }
        else
        {
            if (CroakSrv.UnlikeCroak(likeDto))
            {
                CroakData.LikesCount--;
            }
        }

        IsLiked = CroakSrv.IsLiked(likeDto);
    }

    protected async Task<LikeDto> CreateLikeDto()
    {
        var user = (await AuthStateTask).User;
        var userId = UserMgr.GetUserId(user);

        return new LikeDto
        {
            UserId = userId,
            CroakId = CroakData.Id
        };
    }

    protected async Task UpdateIsLiked()
    {
        var likeDto = await CreateLikeDto();
        IsLiked = CroakSrv.IsLiked(likeDto);
        StateHasChanged();
    }

    private async Task Remove()
    {
        CroakSrv.RemoveCroak(CroakData.Id);
    }

    private async Task<bool> IsDeletableForCurrUser()
    {
        var user = (await AuthStateTask).User;
        var userId = UserMgr.GetUserId(user);

        return CroakData.AuthorId == userId;
    }
}